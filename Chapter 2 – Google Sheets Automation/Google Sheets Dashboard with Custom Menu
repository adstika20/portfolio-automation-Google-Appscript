// Google Sheets Dashboard & Data Viewer (with Custom Menu)

// Create custom menu in Google Sheets
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('Advanced')
  .addItem('Content','buildContent')
  .addItem('Formula','addFormula')
  .addSeparator()
  .addItem('Info','showInfo')
  .addItem('Dashboard','showDashboard')
  .addToUi()
}

// Fetch data from a selected sheet and return it to HTML
function findSheetData(sheetNameSel){
  var ss = SpreadsheetApp.openById('1Hfii_d2iD-7y88YOagk2KCT4BDCntsIY_nIM-sFRLYE');
  var sheet = ss.getSheetByName(sheetNameSel);
  if(sheet != null){
    var data = sheet.getDataRange().getValues();
    Logger.log(data)
    return {'success' : true, 'sheetNameSel' : sheetNameSel, 'data':data};
    }
  return {'success' : false, 'sheetNameSel' : sheetNameSel};
}


// Add formulas set collors
function addFormula(){
  var ss = SpreadsheetApp.openById('1Hfii_d2iD-7y88YOagk2KCT4BDCntsIY_nIM-sFRLYE');
  var sheet = ss.getSheetByName('New Sheet 1');
  var range = sheet.getRange('E1:E10');
  range.setFormula('B1+C1+D1');
  range.setFontColor('red');
  range.setFontWeight('bold');
}

// Render HTML dashboard in a modal dialog
function showDashboard(){
  var ss = SpreadsheetApp.openById('1Hfii_d2iD-7y88YOagk2KCT4BDCntsIY_nIM-sFRLYE');
  var sheets = ss.getSheets();
  var sheetName;
  var sheetData = [];
  for (var i=0; i<sheets.length; i++){
    sheetName = sheets[i].getName();
    sheetData.push(sheetName);
  }
  var t = HtmlService.createTemplateFromFile('dashboard');
  t.data = {sheets:sheetData};
  var html = t.evaluate().setWidth(1200).setHeight(600);
  SpreadsheetApp.getUi().showModalDialog(html, 'Project Exercise');
}


// Create new sheets, fill with random data, copy values from main sheet
function buildContent(){
  var ss = SpreadsheetApp.openById('1Hfii_d2iD-7y88YOagk2KCT4BDCntsIY_nIM-sFRLYE');
  var sheet;
  var valueToCopy = ss.getSheetByName('main').getRange(1,1,10,1).getValues();
  for (var x=1; x<5; x++){
    sheet = ss.getSheetByName('New Sheet '+x);
    if(sheet != null){
      ss.deleteSheet(sheet);
    }
    sheet = ss.insertSheet();
    sheet.setName('New Sheet '+x);
    for (var col =1; col<4; col++){
      for(var row=1; row<11; row++){
        var randNum = Math.ceil(Math.random()*1000);
        sheet.getRange(row, col).setValue(randNum);
      }
    }
    sheet.insertColumnBefore(1);
    sheet.getRange(1,1,10,1).setValues(valueToCopy);
  }
  Logger.log('build')
}

// Display information in a modal dialog
function showInfo(){
  Logger.log('info');
  var t = HtmlService.createTemplateFromFile('info');
  var html = t.evaluate().setWidth(1200).setHeight(600);
  SpreadsheetApp.getUi().showModalDialog(html,'Project Exercise')
}

// HTML File 
// Client-side UI (dropdown + table)

<script>
    var datags = <?!= JSON.stringify(data) ?>;
    console.log(datags);
</script>
<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        table,
        td {
            border: 1px solid black;}
                td {
            width: 100px;
        }
    </style>
</head>
<body>
    <div>Select Sheet :
        <select id="aSheets"></select>
    </div>
    <div id="output"></div>
    <script>
        var output = document.getElementById('output');
        var aSheets = document.getElementById('aSheets');
        aSheets.onchange = function () {
            //console.log(this.value);
            google.script.run.withSuccessHandler(onSuccess).findSheetData(this.value);
        }
        function onSuccess(data) {
            if (data.success) {
                console.log(data.data.length);
                var html = '<table>';
                for (var x = 0; x < data.data.length; x++) {
                    html += '<tr>';
                    for (var i = 0; i < data.data[x].length; i++) {
                        html += '<td>' + data.data[x][i] + '</td>';
                    }
                    html += '</tr>';
                }
                html += '</table>';
                output.innerHTML = html;
            }
            console.log('RESPONSE');
            console.log(data);
        }
        window.onload = function () {
            console.log(datags.sheets);
            for (var x = 0; x < datags.sheets.length; x++) {
                var opt = document.createElement('option');
                opt.value = datags.sheets[x];
                opt.innerHTML = datags.sheets[x];
                aSheets.appendChild(opt);
                console.log(datags.sheets[x]);
            }
        }
    </script>
</body>
</html>
